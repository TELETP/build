# Verification Storage Service (`VerificationStorageService`)

This document describes the `VerificationStorageService` located in `src/system/services/auth/storage.ts`. This service is responsible for caching wallet verification statuses in the browser's `localStorage`.

## Overview

The `VerificationStorageService` provides a simple mechanism to store and retrieve a user's phone verification status locally on their device. This caching helps to:

*   Reduce redundant calls to Firestore to check verification status.
*   Improve performance by providing a quick local lookup.
*   Persist verification status across browser sessions for a limited time.

## Key Methods and Properties

### `private readonly STORAGE_KEY = 'wallet_verification'`
*   The base key used for storing verification data in `localStorage`. The actual key for a specific wallet will be appended with the wallet address (e.g., `wallet_verification_USER_WALLET_ADDRESS`).

### `private getStorageKey(wallet: string): string`
*   A private utility method that constructs the full `localStorage` key for a given `wallet` address.

### `storeVerification(wallet: string): void`
*   **Purpose:** Stores a successful verification status for the given `wallet` address in `localStorage`.
*   **Parameters:**
    *   `wallet`: The user's wallet address.
*   **Logic:**
    *   Creates a `StoredVerification` object containing:
        *   `wallet`: The wallet address.
        *   `isVerified`: `true`.
        *   `lastVerified`: Current timestamp in ISO string format.
        *   `expiresAt`: Current timestamp + 90 days, in ISO string format.
    *   Serializes this object to JSON and stores it in `localStorage` under the key generated by `getStorageKey(wallet)`.
*   **Error Handling:** Catches and logs errors during `localStorage` operations but does not throw them, as `localStorage` is considered non-critical.

### `getVerification(wallet: string): StoredVerification | null`
*   **Purpose:** Retrieves the stored verification status for the given `wallet` address from `localStorage`.
*   **Parameters:**
    *   `wallet`: The user's wallet address.
*   **Returns:**
    *   A `StoredVerification` object if a valid, non-expired entry is found.
    *   `null` if no entry is found, if the entry is malformed, or if the entry has expired.
*   **Expiration Check:**
    *   If an entry is found, it checks if `new Date() > new Date(verification.expiresAt)`.
    *   If expired, it calls `this.clearVerification(wallet)` to remove the stale entry and returns `null`.
*   **Error Handling:** Catches and logs errors (e.g., JSON parsing errors) and returns `null`.

### `clearVerification(wallet: string): void`
*   **Purpose:** Removes the verification status for the given `wallet` address from `localStorage`.
*   **Parameters:**
    *   `wallet`: The user's wallet address.
*   **Error Handling:** Catches and logs errors during `localStorage.removeItem`.

### `isVerified(wallet: string): boolean`
*   **Purpose:** A convenience method to quickly check if a `wallet` is currently considered verified based on `localStorage` data.
*   **Parameters:**
    *   `wallet`: The user's wallet address.
*   **Returns:** `true` if `getVerification(wallet)` returns a non-null object where `isVerified` is true; `false` otherwise.

## Data Structure (`StoredVerification`)

The data stored in `localStorage` for each verified wallet follows this interface (though not explicitly exported, it's implied by the service's logic):

```typescript
interface StoredVerification {
  wallet: string;
  isVerified: boolean; // Always true when stored by current logic
  lastVerified: string; // ISO date string
  expiresAt: string;    // ISO date string (90 days from storage)
}
```

## Usage

This service is typically used by components or hooks (like `useWalletAuth.ts`) as a first check for verification status before querying the backend (Firestore via `VerificationService`).

## Limitations

*   **Client-Side Only:** `localStorage` is browser-specific and cannot be accessed server-side.
*   **User Modifiable:** Data in `localStorage` can be viewed and modified by the user through browser developer tools. Therefore, it should not be solely relied upon for critical security decisions without re-validation against a secure backend (like Firestore). The 90-day expiry and re-check against Firestore mitigate some of this risk for prolonged use.
*   **Storage Limits:** `localStorage` has size limits (usually around 5-10MB). While unlikely to be an issue for this specific use case, it's a general consideration.

The `VerificationStorageService` plays an important role in optimizing the user experience by reducing latency and load on backend services for checking verification status.
